#!/bin/sh

# Modify this script to pass the necessary parameters to 
# the configure of the captive package you're configuring
prefix="@prefix@"
exec_prefix="@exec_prefix@"
CPPFLAGS="@CPPFLAGS@"
LDFLAGS="@LDFLAGS@"
CFLAGS="-g @CFLAGS@"
CXXFLAGS="@CXXFLAGS@"
HOST_TYPE=@HOST_TYPE@
HOST_OS=@HOST_OS@

VS_ENABLE_64BIT=@VS_ENABLE_64BIT@
case $HOST_TYPE in
  Windows)
  CC="${CC} -mno-cygwin"
  LDFLAGS="$LDFLAGS -mno-cygwin"
  ;;
  *)
  ;;
esac
BUILD_FLAG=
if test "x$VS_ENABLE_64BIT" = "xyes"; then
  case $HOST_TYPE in
    Mac)
    CFLAGS="$CFLAGS -arch x86_64"
    CXXFLAGS="$CXXFLAGS -arch x86_64"
    LDFLAGS="$LDFLAGS -arch x86_64"
    ;;
    *)
    ;;
  esac
fi
  
echo "Copying @abs_srcdir@/csrc to @abs_builddir@/csrc"
# create the directory
mkdir -p @abs_builddir@
# copy over all the source
cp -r @abs_srcdir@/csrc @abs_builddir@/
# and make everything user writeable so distcheck will pass
chmod -R u+w @abs_builddir@/csrc
# copy over all patches
if [ -d @abs_srcdir@/patches ]; then
  cp -r @abs_srcdir@/patches @abs_builddir@/
  # and make everything user writeable so distcheck will pass
  chmod -R u+w @abs_builddir@/patches
fi
# Apply patches if any
case $HOST_TYPE in
  Windows)
  if [ -d @abs_builddir@/patches ]; then
    # I shit you not, this needs to happen due to patch
    # on windows 32.  Sit back, drink some coffee, and wait
    find @abs_builddir@/patches -exec dos2unix \{\} \;
    find @abs_builddir@/csrc -exec dos2unix \{\} \;
  fi
  ;;
  *)
  ;;
esac
if [ -d @abs_builddir@/patches ]; then
  cd @abs_builddir@/csrc/src
  for patch in @abs_builddir@/patches/*; do
    if [ -f "$patch" ]; then
      echo "Applying patch: ${patch}"
      patch -p0 --input="$patch" --ignore-whitespace
      if test "$?" -ne 0; then
        echo "Could not apply patch: $patch"
        exit 255
      else
        echo "Applied patch: ${patch}"
      fi
    fi
  done
fi
if [ -d @abs_builddir@/patches ]; then
  rm -rf @abs_builddir@/patches
fi

echo "Configuring @abs_srcdir@"
cd @abs_builddir@/csrc
PATH="$PATH:@abs_top_builddir@@bindir@@" sh ./configure \
  CPPFLAGS="$CPPFLAGS -I@abs_top_builddir@@includedir@" \
  CFLAGS="$CFLAGS -I@abs_top_builddir@@includedir@ -O2" \
  CXXFLAGS="$CXXFLAGS -I@abs_top_builddir@@includedir@" \
  LDFLAGS="$LDFLAGS -L@abs_top_builddir@@libdir@" \
  --prefix="${prefix}" || \
  (echo "Could not configure library: \"@abs_srcdir@\"; you may want to try disabling it or installing your own version" && exit 1)
